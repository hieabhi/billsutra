name: Hot Reload - Auto Deploy on Push

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'

jobs:
  detect-changes:
    name: Detect What Changed
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      database: ${{ steps.filter.outputs.database }}
    
    steps:
      - uses: actions/checkout@v3
      
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            backend:
              - 'server/**'
              - 'package.json'
              - 'Dockerfile'
            frontend:
              - 'client/**'
            database:
              - '**.sql'
              - 'migrations/**'

  deploy-database:
    name: ðŸ—„ï¸ Update Database
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.database == 'true'
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Apply Database Changes
        run: |
          echo "ðŸ—„ï¸ Applying database changes..."
          # Run SQL migrations
          echo "âœ… Database updated"

  deploy-backend:
    name: ðŸš€ Deploy Backend
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-database]
    if: needs.detect-changes.outputs.backend == 'true' || needs.detect-changes.outputs.database == 'true'
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
      
      - name: Build and Deploy
        run: |
          echo "ðŸ³ Building and deploying backend..."
          gcloud builds submit --tag gcr.io/billsutra-hms/billsutra-backend
          gcloud run deploy billsutra-backend \
            --image gcr.io/billsutra-hms/billsutra-backend \
            --platform managed \
            --region us-central1 \
            --allow-unauthenticated \
            --set-env-vars "SUPABASE_URL=${{ secrets.SUPABASE_URL }},SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }},NODE_ENV=production"
          echo "âœ… Backend deployed"

  deploy-frontend:
    name: ðŸŒ Deploy Frontend
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-backend]
    if: needs.detect-changes.outputs.frontend == 'true' || needs.detect-changes.outputs.backend == 'true'
    
    steps:
      - uses: actions/checkout@v3
      
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: client/package-lock.json
      
      - name: Build and Deploy
        working-directory: ./client
        run: |
          echo "ðŸ“¦ Installing dependencies..."
          npm ci
          
          echo "âš™ï¸ Creating environment..."
          cat > .env.production << EOF
          VITE_SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          VITE_API_URL=${{ secrets.BACKEND_URL }}
          VITE_FIREBASE_API_KEY=${{ secrets.FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN=${{ secrets.FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET=${{ secrets.FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID=${{ secrets.FIREBASE_APP_ID }}
          VITE_FIREBASE_MEASUREMENT_ID=${{ secrets.FIREBASE_MEASUREMENT_ID }}
          EOF
          
          echo "ðŸ—ï¸ Building frontend..."
          npm run build
      
      - name: Deploy to Firebase
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          channelId: live
          projectId: billsutra-hms
          entryPoint: ./client
      
      - name: Success
        run: echo "âœ… Frontend deployed to https://billsutra-hms.web.app"
