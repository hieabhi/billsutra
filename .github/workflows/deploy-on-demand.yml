name: Deploy on Demand

on:
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'What to deploy?'
        required: true
        type: choice
        options:
          - all
          - backend
          - frontend
          - database
      environment:
        description: 'Environment'
        required: true
        type: choice
        default: 'production'
        options:
          - production
          - staging

jobs:
  deploy-database:
    name: Update Database Schema
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.deploy_target == 'all' || github.event.inputs.deploy_target == 'database' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Run Supabase Migrations
        run: |
          echo "ðŸ—„ï¸ Applying database changes to Supabase..."
          # This would run SQL files against Supabase
          curl -X POST \
            "https://tpbbhstshioyggintazl.supabase.co/rest/v1/rpc/exec_sql" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d @migrations/latest.sql || true
          echo "âœ… Database updated"

  deploy-backend:
    name: Deploy Backend to Cloud Run
    runs-on: ubuntu-latest
    needs: [deploy-database]
    # Allow backend to run even if database job is skipped
    if: |
      always() &&
      (github.event.inputs.deploy_target == 'all' || github.event.inputs.deploy_target == 'backend')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
      
      - name: Build and push Docker image
        run: |
          echo "ðŸ³ Building backend Docker image..."
          gcloud builds submit --tag gcr.io/billsutra-hms/billsutra-backend .
          echo "âœ… Docker image built"
      
      - name: Deploy to Cloud Run
        run: |
          echo "â˜ï¸ Deploying to Cloud Run..."
          gcloud run deploy billsutra-backend \
            --image gcr.io/billsutra-hms/billsutra-backend \
            --platform managed \
            --region us-central1 \
            --allow-unauthenticated \
            --port 8080 \
            --set-env-vars "SUPABASE_URL=${{ secrets.SUPABASE_URL }},SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }},SUPABASE_SERVICE_KEY=${{ secrets.SUPABASE_SERVICE_KEY }},NODE_ENV=${{ github.event.inputs.environment }}"
          echo "âœ… Backend deployed to Cloud Run"
      
      - name: Get Backend URL
        id: get-url
        run: |
          URL=$(gcloud run services describe billsutra-backend --region us-central1 --format 'value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "ðŸŒ Backend URL: $URL"

  deploy-frontend:
    name: Deploy Frontend to Firebase Hosting
    runs-on: ubuntu-latest
    needs: [deploy-backend]
    # Allow frontend to run even if backend job is skipped
    if: |
      always() &&
      (github.event.inputs.deploy_target == 'all' || github.event.inputs.deploy_target == 'frontend')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        working-directory: ./client
        run: |
          echo "ðŸ“¦ Installing frontend dependencies..."
          npm install
      
      - name: Get Backend URL
        id: backend-url
        run: |
          echo "Getting backend URL from Cloud Run..."
          sudo apt-get install -y jq
          echo "url=${{ secrets.BACKEND_URL }}" >> $GITHUB_OUTPUT
      
      - name: Create production environment file
        working-directory: ./client
        run: |
          echo "âš™ï¸ Creating production .env file..."
          cat > .env.production << EOF
          VITE_SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          VITE_API_URL=${{ secrets.BACKEND_URL }}
          VITE_FIREBASE_API_KEY=${{ secrets.FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN=${{ secrets.FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET=${{ secrets.FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID=${{ secrets.FIREBASE_APP_ID }}
          VITE_FIREBASE_MEASUREMENT_ID=${{ secrets.FIREBASE_MEASUREMENT_ID }}
          EOF
          echo "âœ… Environment file created"
      
      - name: Build frontend
        working-directory: ./client
        run: |
          echo "ðŸ—ï¸ Building frontend..."
          npm run build
          echo "âœ… Frontend built successfully"
      
      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          channelId: live
          projectId: billsutra-hms

  notify-completion:
    name: Deployment Complete
    runs-on: ubuntu-latest
    needs: [deploy-database, deploy-backend, deploy-frontend]
    if: always()
    
    steps:
      - name: Deployment Summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸŽ‰ DEPLOYMENT COMPLETE!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ“Š Deployed Components:"
          echo "  âœ… Database: Supabase"
          echo "  âœ… Backend: Google Cloud Run"
          echo "  âœ… Frontend: Firebase Hosting"
          echo ""
          echo "ðŸŒ Live URLs:"
          echo "  Frontend: https://billsutra-hms.web.app"
          echo "  Backend: Check Cloud Run console"
          echo ""
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
